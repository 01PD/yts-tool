<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>YouTube ì±„ë„ ë¶„ì„ íˆ´ v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1120;
      --bg-alt: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --border: #1f2937;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --radius-lg: 18px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text);
      overflow-x: hidden;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
    }

    header p {
      margin: 0;
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    /* ===== 3ë‹¨ ë ˆì´ì•„ì›ƒ: ì¢Œ 1/6, ì¤‘ê°„ 4/6, ìš° 1/6 ===== */
    .main-layout {
      display: grid;
      grid-template-columns: minmax(180px, 1fr) minmax(0, 4fr) minmax(220px, 1fr);
      gap: 12px;
      /* ì „ì²´ í™”ë©´ ë†’ì´ë¥¼ ê±°ì˜ ë‹¤ ì“°ê²Œ í•´ì„œ ê°€ìš´ë°ë§Œ ìŠ¤í¬ë¡¤ */
      min-height: calc(100vh - 80px);
    }

    .panel {
      display: flex;
      flex-direction: column;
    }

    .panel-inner {
      background: radial-gradient(circle at top left, #020617 0, #020617 20%, #020617 55%, #000 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.15);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 14px;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 260px;
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title-row h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .panel-title-row span {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    /* ë°˜ì‘í˜•: í™”ë©´ì´ ì¢ì•„ì§€ë©´ ìœ„ì—ì„œ ì•„ë˜ë¡œ ìŒ“ì´ê¸° */
    @media (max-width: 1000px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      .panel-inner {
        min-height: auto;
      }
    }

    /* ===== í¼ / ì»¨íŠ¸ë¡¤ ===== */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.78rem;
    }

    .field label {
      color: var(--text-soft);
    }

    .input, select {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.8);
      color: var(--text);
      font-size: 0.86rem;
      outline: none;
    }

    .input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }

    .input::placeholder {
      color: #6b7280;
    }

    .help-text {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .mode-toggle {
      display: flex;
      gap: 6px;
      font-size: 0.72rem;
    }

    .mode-button {
      flex: 1;
      padding: 5px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.7);
      color: var(--text-soft);
      cursor: pointer;
    }

    .mode-button.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .btn-primary {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.86rem;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0b1120;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-secondary {
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      cursor: pointer;
      font-size: 0.78rem;
      background: rgba(15,23,42,0.7);
      color: var(--text-soft);
      white-space: nowrap;
    }

    .btn-primary:disabled,
    .btn-secondary:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .controls-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .status-bar {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .status-message {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-message.danger {
      color: var(--danger);
    }

    .status-message.loading-dot::after {
      content: " â€¢";
      animation: dots 1s infinite steps(3, end);
    }

    @keyframes dots {
      0%, 20% { content: " â€¢"; }
      40% { content: " â€¢â€¢"; }
      60%, 100% { content: " â€¢â€¢â€¢"; }
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      font-size: 0.74rem;
      color: var(--text-soft);
      align-self: flex-end;
    }

    .pill strong {
      color: var(--accent);
      font-weight: 600;
    }

    /* ===== ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (ê°€ìš´ë° 4/6 ì˜ì—­) ===== */
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .results-header h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .results-header span {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 2px;
      flex: 1;
      /* ê°€ìš´ë° ê²°ê³¼ì°½ë§Œ ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
      max-height: calc(100vh - 170px);
      overflow-y: auto;
      overflow-x: hidden;
    }

    .video-card {
      display: grid;
      /* ì¸ë„¤ì¼ í¬ê²Œ (ë°ìŠ¤í¬íƒ‘ ê¸°ì¤€) */
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.7);
      overflow: hidden;
      min-height: 150px;
    }

    /* í™”ë©´ì´ ì¢ì„ ë• ìœ„ì•„ë˜ë¡œ ë°°ì¹˜ */
    @media (max-width: 900px) {
      .video-card {
        grid-template-columns: 1fr;
      }
    }

    .video-thumb {
      position: relative;
      overflow: hidden;
      /* ì¸ë„¤ì¼ ë¹„ìœ¨ ìœ ì§€ (16:9) */
      aspect-ratio: 16 / 9;
    }

    .video-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .video-duration {
      position: absolute;
      right: 6px;
      bottom: 6px;
      font-size: 0.72rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.75);
      color: #f9fafb;
    }

    .video-body {
      padding: 8px 10px 9px 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .video-title {
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .video-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .video-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .video-link {
      margin-top: 4px;
      font-size: 0.76rem;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .video-link a {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.95);
      color: var(--accent);
      text-decoration: none;
    }

    .video-link a.primary {
      background: var(--accent-soft);
    }

    .video-link a:hover {
      text-decoration: underline;
    }

    /* ===== ì±„ë„ í›„ë³´ ì¹´ë“œ ===== */
    .channel-card {
      display: grid;
      grid-template-columns: 80px minmax(0, 1fr);
      gap: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.7);
      padding: 8px;
      cursor: pointer;
    }

    .channel-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }

    .channel-thumb {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .channel-thumb img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
    }

    .channel-body .channel-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .channel-body .channel-id {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .channel-body .channel-hint {
      font-size: 0.74rem;
      color: var(--accent);
      margin-top: 4px;
    }

    /* ===== ì¢Œì¸¡ ìš”ì•½ ë¶„ì„ (1/6) ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .stat-item {
      padding: 6px 7px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
    }

    .stat-label {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-bottom: 1px;
    }

    .stat-value {
      font-size: 0.88rem;
      font-weight: 600;
    }

    .analysis-block {
      margin-top: 6px;
    }

    .analysis-block h3 {
      margin: 0 0 4px;
      font-size: 0.86rem;
    }

    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.76rem;
      max-height: 90px;
      overflow: auto;
    }

    .keyword-chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.8);
    }

    .keyword-chip span.count {
      color: var(--accent);
      margin-left: 4px;
    }

    .empty-state {
      font-size: 0.78rem;
      color: var(--text-soft);
      padding: 8px 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>
        YouTube ì±„ë„ ë¶„ì„ íˆ´
        <span class="badge">v1 Â· HTML Only</span>
      </h1>
      <p>ì±„ë„Â·ì˜ìƒ ë©”íƒ€ë°ì´í„°ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
    </header>

    <!-- ===== 3ë‹¨ ë©”ì¸ ë ˆì´ì•„ì›ƒ ===== -->
    <section class="main-layout">
      <!-- ì¢Œì¸¡ 1/6 : ìš”ì•½ ë¶„ì„ -->
      <aside class="panel">
        <div class="panel-inner">
          <div class="panel-title-row">
            <h2>ìš”ì•½ ë¶„ì„</h2>
            <span>ê¸°ë³¸ í†µê³„ & ì œëª© í‚¤ì›Œë“œ</span>
          </div>

          <div id="statsContainer" class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">ì´ ì¡°íšŒìˆ˜ í•©ê³„</div>
              <div class="stat-value" id="statTotalViews">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ì˜ìƒ 1ê°œë‹¹ í‰ê·  ì¡°íšŒìˆ˜</div>
              <div class="stat-value" id="statAvgViews">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">í‰ê·  VPH (ì¡°íšŒìˆ˜/ì—…ë¡œë“œ í›„ ì‹œê°„)</div>
              <div class="stat-value" id="statAvgVph">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">í‰ê·  ê¸¸ì´ (ë¶„)</div>
              <div class="stat-value" id="statAvgDuration">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">í‰ê·  ì œëª© ê¸€ì ìˆ˜</div>
              <div class="stat-value" id="statAvgTitleLen">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ê°€ì¥ ìµœê·¼ ì—…ë¡œë“œ</div>
              <div class="stat-value" id="statLatest">-</div>
            </div>
          </div>

          <div class="analysis-block">
            <h3>ì œëª© í‚¤ì›Œë“œ TOP 15</h3>
            <div id="keywordList" class="keyword-list">
              <span class="empty-state">
                ì œëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì—ì„œ ë§ì´ ì“°ì¸ ë‹¨ì–´ë“¤ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
              </span>
            </div>
          </div>

          <div class="analysis-block">
            <h3>ì„¤ëª…</h3>
            <div class="help-text">
              ì´ ì˜ì—­ì€ v1 ê¸°ì¤€ <strong>ë©”íƒ€ë°ì´í„° í†µê³„</strong>ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.<br />
              ë‹¤ìŒ ë²„ì „ì—ì„œ ìŠ¤í¬ë¦½íŠ¸/ìë§‰ + AI ë¶„ì„ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </aside>

      <!-- ê°€ìš´ë° 4/6 : ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
      <main class="panel">
        <div class="panel-inner">
          <div class="results-header">
            <h2>ì˜ìƒ / ì±„ë„ ëª©ë¡</h2>
            <span id="resultsInfo">ì•„ì§ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
          </div>
          <div id="resultsList" class="results-list">
            <div class="empty-state">
              ì´ ì˜ì—­ì— ë¶„ì„ ëŒ€ìƒ ì˜ìƒ ì¹´ë“œ ë˜ëŠ” ì±„ë„ í›„ë³´ ì¹´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </main>

      <!-- ìš°ì¸¡ 1/6 : ê²€ìƒ‰/í•„í„° ì˜ì—­ -->
      <aside class="panel">
        <div class="panel-inner">
          <div class="panel-title-row">
            <h2>ê²€ìƒ‰ & í•„í„°</h2>
            <span style="font-size:0.74rem;">ìš°ì¸¡ íŒ¨ë„ì—ì„œ ì¡°ê±´ ì„¤ì •</span>
          </div>

          <div class="controls-grid">
            <div class="field">
              <label for="apiKey">YouTube API í‚¤ <span style="color:#f97373">*</span></label>
              <input
                id="apiKey"
                class="input"
                type="password"
                placeholder="ë¸Œë¼ìš°ì € í‚¤ë¥¼ ì—¬ê¸° ì…ë ¥ (ì½”ë“œì— ì§ì ‘ ë„£ì§€ ë§ˆì„¸ìš”)"
              />
              <div class="help-text">
                Google Cloudì—ì„œ ì–»ì€ <strong>API í‚¤</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                í‚¤ëŠ” ì½”ë“œì— ì ì§€ ë§ê³ , í•­ìƒ ì´ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ëŠ” ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
              </div>
            </div>

            <div class="field">
              <label>ê²€ìƒ‰ ëª¨ë“œ</label>
              <div class="mode-toggle">
                <button type="button" class="mode-button active" data-mode="channel">
                  ì±„ë„ ê¸°ì¤€
                </button>
                <button type="button" class="mode-button" data-mode="keyword">
                  í‚¤ì›Œë“œ / ë§í¬
                </button>
              </div>
              <div class="help-text">
                ì±„ë„(ë§í¬/ID/ì´ë¦„) ê¸°ì¤€ ë¶„ì„ ë˜ëŠ” í‚¤ì›Œë“œ/ì˜ìƒë§í¬ ê¸°ì¤€ ë¶„ì„ ì¤‘ ì„ íƒ.
              </div>
            </div>

            <div class="field" id="channelField">
              <label for="channelId">ì±„ë„ ì…ë ¥</label>
              <input
                id="channelId"
                class="input"
                type="text"
                placeholder="ì±„ë„ URL, ID(UC...), @í•¸ë“¤, ë˜ëŠ” ì±„ë„ ì´ë¦„(ì˜ˆ: ì‚¬ì—°ê·¸ë„¤)"
              />
              <div class="help-text">
                ì˜ˆì‹œ: <br />
                Â· <code>https://www.youtube.com/@sayongeune</code><br />
                Â· <code>https://www.youtube.com/channel/UCxxxx</code><br />
                Â· <code>@sayongeune</code> ë˜ëŠ” <code>UCxxxx...</code><br />
                Â· <code>ì‚¬ì—°ê·¸ë„¤</code> (ì±„ë„ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰)
              </div>
            </div>

            <div class="field" id="keywordField" style="display:none;">
              <label for="keyword">í‚¤ì›Œë“œ / ì˜ìƒ URL</label>
              <input
                id="keyword"
                class="input"
                type="text"
                placeholder="í‚¤ì›Œë“œ ë˜ëŠ” ì˜ìƒ ë§í¬ (ì˜ˆ: https://youtu.be/...)"
              />
              <div class="help-text">
                Â· í‚¤ì›Œë“œ: <code>ì´í˜¼ í›„ 10ë…„, ì¥ë¡€ì‹ ë³µìˆ˜...</code><br />
                Â· ë˜ëŠ” <strong>ì˜ìƒ URL</strong>ì„ ë„£ìœ¼ë©´ ê·¸ ì˜ìƒë§Œ ë‹¨ë… ë¶„ì„í•©ë‹ˆë‹¤.
              </div>
            </div>

            <div class="field">
              <label for="order">ì •ë ¬ ê¸°ì¤€</label>
              <select id="order">
                <option value="date">ìµœì‹ ìˆœ</option>
                <option value="viewCount">ì¡°íšŒìˆ˜ ìˆœ</option>
                <option value="relevance">ê´€ë ¨ë„ ìˆœ (í‚¤ì›Œë“œ ì‚¬ìš© ì‹œ)</option>
              </select>
              <div class="help-text">YouTube Data API ì •ë ¬ ê¸°ì¤€ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
            </div>

            <div class="field">
              <label for="maxResults">ìµœëŒ€ ì˜ìƒ ê°œìˆ˜ (1~150)</label>
              <input
                id="maxResults"
                class="input"
                type="number"
                min="1"
                max="150"
                value="50"
              />
              <div class="help-text">í˜ì´ì§€ë„¤ì´ì…˜ì„ ëŒë¦¬ë©° ìµœëŒ€ ì´ ìˆ«ìê¹Œì§€ ê°€ì ¸ì˜µë‹ˆë‹¤.</div>
            </div>

            <div class="field">
              <label for="daysRange">ìµœê·¼ Nì¼ ì´ë‚´ ì—…ë¡œë“œë§Œ</label>
              <input
                id="daysRange"
                class="input"
                type="number"
                min="0"
                value="0"
              />
              <div class="help-text">0ì´ë©´ ê¸°ê°„ ì œí•œ ì—†ìŒ, 30ì´ë©´ ìµœê·¼ í•œ ë‹¬ ì˜ìƒë§Œ ë¶„ì„.</div>
            </div>
          </div>

          <div class="controls-actions">
            <button type="button" class="btn-secondary" id="exportCsvBtn" disabled>
              CSV ë‹¤ìš´ë¡œë“œ
            </button>
            <button type="button" class="btn-primary" id="fetchBtn">
              ë¶ˆëŸ¬ì˜¤ê¸° & ë¶„ì„
            </button>
          </div>

          <div class="status-bar">
            <div class="status-message" id="statusMessage">
              ì¤€ë¹„ ì™„ë£Œ. API í‚¤ì™€ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.
            </div>
            <div class="pill" id="statusSummary">
              <span>ë¶„ì„ëœ ì˜ìƒ: <strong>0</strong>ê°œ</span>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </div>

  <script>
    // ------ ê°„ë‹¨í•œ ìƒíƒœ ------
    let currentMode = "channel"; // "channel" | "keyword"
    let currentVideos = []; // videos.list ê²°ê³¼ë¥¼ ë‹´ëŠ” ë°°ì—´

    const modeButtons = document.querySelectorAll(".mode-button");
    const channelField = document.getElementById("channelField");
    const keywordField = document.getElementById("keywordField");

    const apiKeyInput = document.getElementById("apiKey");
    const channelIdInput = document.getElementById("channelId");
    const keywordInput = document.getElementById("keyword");
    const orderSelect = document.getElementById("order");
    const maxResultsInput = document.getElementById("maxResults");
    const daysRangeInput = document.getElementById("daysRange");

    const fetchBtn = document.getElementById("fetchBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");

    const statusMessageEl = document.getElementById("statusMessage");
    const statusSummaryEl = document.getElementById("statusSummary");
    const resultsInfoEl = document.getElementById("resultsInfo");
    const resultsListEl = document.getElementById("resultsList");

    const statTotalViewsEl = document.getElementById("statTotalViews");
    const statAvgViewsEl = document.getElementById("statAvgViews");
    const statAvgVphEl = document.getElementById("statAvgVph");
    const statAvgDurationEl = document.getElementById("statAvgDuration");
    const statAvgTitleLenEl = document.getElementById("statAvgTitleLen");
    const statLatestEl = document.getElementById("statLatest");
    const keywordListEl = document.getElementById("keywordList");

    // ------ ëª¨ë“œ í† ê¸€ ------
    modeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.mode;
        currentMode = mode;
        modeButtons.forEach((b) => b.classList.toggle("active", b === btn));
        if (mode === "channel") {
          channelField.style.display = "";
          keywordField.style.display = "none";
        } else {
          channelField.style.display = "none";
          keywordField.style.display = "";
        }
      });
    });

    // ------ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ------
    function setStatus(message, type = "info", loading = false) {
      statusMessageEl.textContent = message;
      statusMessageEl.classList.toggle("danger", type === "error");
      statusMessageEl.classList.toggle("loading-dot", loading);
    }

    function updateSummaryCount(count) {
      statusSummaryEl.innerHTML = 'ë¶„ì„ëœ ì˜ìƒ: <strong>' + count + "</strong>ê°œ";
    }

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return Number(num).toLocaleString("ko-KR");
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return y + "." + m + "." + day;
    }

    function timeSinceUpload(dateStr) {
      const now = Date.now();
      const t = new Date(dateStr).getTime();
      if (isNaN(t)) return "-";
      const diffMs = now - t;
      const diffDays = diffMs / (1000 * 60 * 60 * 24);
      if (diffDays < 1) {
        const hours = diffMs / (1000 * 60 * 60);
        return hours.toFixed(1) + "ì‹œê°„ ì „";
      }
      if (diffDays < 30) {
        return Math.floor(diffDays) + "ì¼ ì „";
      }
      const months = diffDays / 30;
      if (months < 12) {
        return Math.floor(months) + "ê°œì›” ì „";
      }
      const years = diffDays / 365;
      return Math.floor(years) + "ë…„ ì „";
    }

    // ISO 8601 duration (PTxxHxxMxxS) -> ì´ˆ ë‹¨ìœ„
    function isoDurationToSeconds(iso) {
      if (!iso || typeof iso !== "string") return 0;
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1] || "0", 10);
      const minutes = parseInt(match[2] || "0", 10);
      const seconds = parseInt(match[3] || "0", 10);
      return hours * 3600 + minutes * 60 + seconds;
    }

    function formatSecondsToHMS(totalSeconds) {
      if (!totalSeconds || isNaN(totalSeconds)) return "00:00";
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) {
        return [h, m.toString().padStart(2, "0"), s.toString().padStart(2, "0")].join(":");
      }
      return [m, s.toString().padStart(2, "0")].map((v) => v.toString().padStart(2, "0")).join(":");
    }

    // ë‹¨ìˆœ í† í¬ë‚˜ì´ì € (ì œëª© í‚¤ì›Œë“œìš©)
    function tokenizeTitle(title) {
      if (!title) return [];
      const cleaned = title
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
      if (!cleaned) return [];
      const tokens = cleaned.split(" ");
      return tokens.filter((t) => t.length > 1);
    }

    // ì˜ìƒ URL or IDì—ì„œ videoId ì¶”ì¶œ
    function extractVideoIdFromInput(raw) {
      const input = raw.trim();
      if (!input) return null;
      // ì´ë¯¸ 11ìë¦¬ ID íŒ¨í„´ì´ë©´
      if (/^[0-9A-Za-z_-]{11}$/.test(input)) return input;
      if (!input.startsWith("http")) return null;
      try {
        const u = new URL(input);
        const host = u.hostname.replace(/^www\./, "");
        const pathParts = u.pathname.split("/").filter(Boolean);

        // ì¼ë°˜ watch URL: ?v=ID
        const vParam = u.searchParams.get("v");
        if (vParam && /^[0-9A-Za-z_-]{11}$/.test(vParam)) return vParam;

        // youtu.be/ID
        if (host === "youtu.be" && pathParts[0] && /^[0-9A-Za-z_-]{11}$/.test(pathParts[0])) {
          return pathParts[0];
        }

        // /shorts/ID, /embed/ID ë“±
        const idx = pathParts.findIndex((p) => p === "shorts" || p === "embed");
        if (idx >= 0 && pathParts[idx + 1] && /^[0-9A-Za-z_-]{11}$/.test(pathParts[idx + 1])) {
          return pathParts[idx + 1];
        }
      } catch (e) {
        return null;
      }
      return null;
    }

    // ì±„ë„ ì…ë ¥ ì²˜ë¦¬: URL / ID / @ / ì´ë¦„ â†’ ì±„ë„ ID ë˜ëŠ” í›„ë³´ ë¦¬ìŠ¤íŠ¸
    async function resolveChannelFromInput(apiKey, rawInput) {
      const input = rawInput.trim();
      if (!input) {
        throw new Error("ì±„ë„ ì…ë ¥ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      }

      // 1) ì´ë¯¸ UCë¡œ ì‹œì‘í•˜ëŠ” ID
      if (/^UC[0-9A-Za-z_-]{20,}$/.test(input)) {
        return { type: "id", id: input };
      }

      let handle = null;
      let channelId = null;
      let nameQuery = null;

      // 2) URL íŒŒì‹±
      if (input.startsWith("http")) {
        try {
          const u = new URL(input);
          const host = u.hostname.replace(/^www\./, "");
          const parts = u.pathname.split("/").filter(Boolean);

          if (host === "youtube.com" || host === "m.youtube.com") {
            if (parts[0] === "channel" && parts[1]) {
              channelId = parts[1];
            } else if (parts[0] && parts[0].startsWith("@")) {
              handle = "@" + parts[0].replace(/^@/, "");
            } else if ((parts[0] === "c" || parts[0] === "user") && parts[1]) {
              nameQuery = decodeURIComponent(parts[1]);
            }
          }
          // youtu.beëŠ” ë³´í†µ ì˜ìƒìš©ì´ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” íŒ¨ìŠ¤
        } catch (e) {
          // ë¬´ì‹œ
        }
      }

      // 3) @í•¸ë“¤ (URLì´ ì•„ë‹ˆê³  ê·¸ëƒ¥ @ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°)
      if (!handle && input.startsWith("@")) {
        handle = input;
      }

      // 3-1) ì±„ë„ IDê°€ URLì—ì„œ ë‚˜ì™”ìœ¼ë©´ ë°”ë¡œ ë°˜í™˜
      if (channelId) {
        return { type: "id", id: channelId };
      }

      // 3-2) í•¸ë“¤ë¡œ ì±„ë„ ì¡°íšŒ
      if (handle) {
        const handleClean = handle.replace(/^@/, "");
        const params = new URLSearchParams({
          key: apiKey,
          part: "snippet",
          forHandle: handleClean,
        });
        const url = "https://www.googleapis.com/youtube/v3/channels?" + params.toString();
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("ì±„ë„ í•¸ë“¤ ì¡°íšŒ ì‹¤íŒ¨ (HTTP " + res.status + ")");
        }
        const data = await res.json();
        if (data.items && data.items.length > 0) {
          return { type: "id", id: data.items[0].id };
        }
        throw new Error("í•´ë‹¹ í•¸ë“¤ì˜ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

      // 4) ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ 'ì±„ë„ ì´ë¦„' ê¸°ë°˜ ê²€ìƒ‰
      nameQuery = nameQuery || input;
      const searchParams = new URLSearchParams({
        key: apiKey,
        part: "snippet",
        q: nameQuery,
        type: "channel",
        maxResults: "25",
      });
      const url = "https://www.googleapis.com/youtube/v3/search?" + searchParams.toString();
      const res = await fetch(url);
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        const msg =
          errData.error && errData.error.message
            ? errData.error.message
            : "ì±„ë„ ì´ë¦„ ê²€ìƒ‰ ì‹¤íŒ¨ (HTTP " + res.status + ")";
        throw new Error(msg);
      }
      const data = await res.json();
      let items = data.items || [];
      if (!items.length) {
        throw new Error("í•´ë‹¹ ì´ë¦„ì˜ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

      const trimmed = nameQuery.trim();
      const exactMatches = items.filter(
        (it) =>
          it.snippet &&
          it.snippet.title &&
          it.snippet.title.trim() === trimmed
      );

      const toChannelObj = (it) => {
        const sn = it.snippet || {};
        const thumbs = sn.thumbnails || {};
        const thumbObj = thumbs.medium || thumbs.default || null;
        return {
          id: it.id.channelId,
          title: sn.title || "",
          description: sn.description || "",
          thumbnail: thumbObj,
        };
      };

      if (exactMatches.length === 1) {
        // ì •í™•íˆ í•˜ë‚˜ë©´ ë°”ë¡œ IDë¡œ ë¶„ì„
        return { type: "id", id: exactMatches[0].id.channelId };
      }

      if (exactMatches.length > 1) {
        // ê°™ì€ ì œëª©ì˜ ì±„ë„ ì—¬ëŸ¬ ê°œ â†’ ì „ë¶€ í›„ë³´ ë¦¬ìŠ¤íŠ¸ë¡œ
        return {
          type: "multi",
          channels: exactMatches.map(toChannelObj),
        };
      }

      // ì •í™• ì¼ì¹˜ê°€ ì—†ìœ¼ë©´ ê²€ìƒ‰ ê²°ê³¼ ì „ë¶€ í›„ë³´ë¡œ
      const channels = items.map(toChannelObj);
      if (channels.length === 1) {
        return { type: "id", id: channels[0].id };
      }
      return { type: "multi", channels };
    }

    // ------ API í˜¸ì¶œ ë©”ì¸ í•¨ìˆ˜ ------
    async function fetchVideos() {
      const apiKey = apiKeyInput.value.trim();
      const channelIdRaw = channelIdInput.value.trim();
      const keywordRaw = keywordInput.value.trim();
      const order = orderSelect.value;
      const maxResults = Math.min(
        150,
        Math.max(1, parseInt(maxResultsInput.value || "50", 10))
      );
      const daysRange = Math.max(0, parseInt(daysRangeInput.value || "0", 10));

      if (!apiKey) {
        setStatus("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      if (currentMode === "channel" && !channelIdRaw) {
        setStatus("ì±„ë„ ì…ë ¥ì„ í•´ì£¼ì„¸ìš”. (URL/ID/@/ì´ë¦„)", "error");
        return;
      }

      if (currentMode === "keyword" && !keywordRaw) {
        setStatus("í‚¤ì›Œë“œ ë˜ëŠ” ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      fetchBtn.disabled = true;
      exportCsvBtn.disabled = true;
      setStatus("YouTubeì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", "info", true);
      resultsListEl.innerHTML = "";
      resultsInfoEl.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      currentVideos = [];
      updateSummaryCount(0);
      resetStats();

      try {
        // ---------------- í‚¤ì›Œë“œ ëª¨ë“œ: ì˜ìƒ ë§í¬ ì²˜ë¦¬ ìš°ì„  ----------------
        if (currentMode === "keyword") {
          const vidFromLink = extractVideoIdFromInput(keywordRaw);
          if (vidFromLink) {
            // ë‹¨ì¼ ì˜ìƒ ìƒì„¸ í˜¸ì¶œ
            const videosBase = "https://www.googleapis.com/youtube/v3/videos";
            const videosParams = new URLSearchParams({
              key: apiKey,
              part: "snippet,contentDetails,statistics",
              id: vidFromLink,
            });
            const url = videosBase + "?" + videosParams.toString();
            const res = await fetch(url);
            if (!res.ok) {
              const errData = await res.json().catch(() => ({}));
              const msg =
                errData.error && errData.error.message
                  ? errData.error.message
                  : "ì˜ìƒ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨ (HTTP " + res.status + ")";
              throw new Error(msg);
            }
            const data = await res.json();
            const items = data.items || [];
            if (!items.length) {
              throw new Error("í•´ë‹¹ ì˜ìƒ ID/URLë¡œ ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            currentVideos = items;
            renderVideos();
            computeStats();
            setStatus("ë‹¨ì¼ ì˜ìƒ ë¶„ì„ ì™„ë£Œ.", "info");
            resultsInfoEl.textContent = "1ê°œ ì˜ìƒ";
            updateSummaryCount(1);
            exportCsvBtn.disabled = false;
            return;
          }
        }

        // ---------------- ì±„ë„ ëª¨ë“œ: ì±„ë„ ì…ë ¥ í•´ì„ ----------------
        let channelIdForSearch = null;
        let channelCandidates = null;

        if (currentMode === "channel") {
          const resolution = await resolveChannelFromInput(apiKey, channelIdRaw);

          if (resolution.type === "id") {
            channelIdForSearch = resolution.id;
          } else if (resolution.type === "multi") {
            channelCandidates = resolution.channels || [];
            // í›„ë³´ ì±„ë„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í›„ ì¢…ë£Œ
            if (!channelCandidates.length) {
              throw new Error("ì±„ë„ í›„ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
            renderChannelCandidates(channelCandidates);
            setStatus(
              "ì±„ë„ ì´ë¦„ '" +
                channelIdRaw +
                "'ë¡œ " +
                channelCandidates.length +
                "ê°œ ì±„ë„ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì±„ë„ì„ í´ë¦­í•˜ë©´ ì˜ìƒ ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤.",
              "info"
            );
            resultsInfoEl.textContent = channelCandidates.length + "ê°œ ì±„ë„ í›„ë³´";
            fetchBtn.disabled = false;
            exportCsvBtn.disabled = true;
            return;
          } else {
            throw new Error("ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        }

        // ---------------- ê³µí†µ: ê²€ìƒ‰ API (video ê²€ìƒ‰) ----------------
        const searchBase = "https://www.googleapis.com/youtube/v3/search";
        const searchParams = new URLSearchParams({
          key: apiKey,
          part: "snippet",
          maxResults: "50",
          type: "video",
          order: order,
        });

        if (currentMode === "channel") {
          // ì±„ë„ ID ê¸°ì¤€ìœ¼ë¡œ ì˜ìƒ ê²€ìƒ‰
          searchParams.set("channelId", channelIdForSearch);
        } else {
          // í‚¤ì›Œë“œ ê²€ìƒ‰ ëª¨ë“œ (ì´ë¯¸ ë§í¬ëŠ” ìœ„ì—ì„œ ì²˜ë¦¬)
          searchParams.set("q", keywordRaw);
        }

        if (daysRange > 0) {
          const now = new Date();
          const past = new Date(now.getTime() - daysRange * 24 * 60 * 60 * 1000);
          searchParams.set("publishedAfter", past.toISOString());
        }

        let fetched = 0;
        let nextPageToken = null;
        const videoIds = [];

        do {
          if (nextPageToken) {
            searchParams.set("pageToken", nextPageToken);
          } else {
            searchParams.delete("pageToken");
          }

          const url = searchBase + "?" + searchParams.toString();
          const res = await fetch(url);
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            const msg = errData.error && errData.error.message
              ? errData.error.message
              : "ê²€ìƒ‰ API ìš”ì²­ ì‹¤íŒ¨ (HTTP " + res.status + ")";
            throw new Error(msg);
          }
          const data = await res.json();
          const items = data.items || [];
          items.forEach((item) => {
            if (item.id && item.id.videoId) {
              videoIds.push(item.id.videoId);
            }
          });
          fetched += items.length;
          nextPageToken = data.nextPageToken && fetched < maxResults ? data.nextPageToken : null;
        } while (nextPageToken && fetched < maxResults);

        if (videoIds.length === 0) {
          setStatus("ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.", "info");
          resultsInfoEl.textContent = "0ê°œì˜ ì˜ìƒ";
          resultsListEl.innerHTML =
            '<div class="empty-state">ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ê±°ë‚˜, ê²€ìƒ‰ ì¡°ê±´ì´ ë„ˆë¬´ ì œí•œì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
          return;
        }

        const detailedVideos = [];
        const videosBase = "https://www.googleapis.com/youtube/v3/videos";
        const uniqueIds = Array.from(new Set(videoIds)).slice(0, maxResults);

        for (let i = 0; i < uniqueIds.length; i += 50) {
          const batchIds = uniqueIds.slice(i, i + 50);
          const videosParams = new URLSearchParams({
            key: apiKey,
            part: "snippet,contentDetails,statistics",
            id: batchIds.join(","),
          });
          const url = videosBase + "?" + videosParams.toString();
          const res = await fetch(url);
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            const msg =
              errData.error && errData.error.message
                ? errData.error.message
                : "videos.list API ìš”ì²­ ì‹¤íŒ¨ (HTTP " + res.status + ")";
            throw new Error(msg);
          }
          const data = await res.json();
          (data.items || []).forEach((item) => detailedVideos.push(item));
        }

        detailedVideos.sort((a, b) => {
          const da = new Date(a.snippet.publishedAt || 0).getTime();
          const db = new Date(b.snippet.publishedAt || 0).getTime();
          return db - da;
        });

        currentVideos = detailedVideos;
        renderVideos();
        computeStats();

        setStatus(
          "ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ. ì´ " + currentVideos.length + "ê°œ ì˜ìƒ ë¶„ì„ë¨.",
          "info"
        );
        resultsInfoEl.textContent = currentVideos.length + "ê°œì˜ ì˜ìƒ";
        updateSummaryCount(currentVideos.length);
        exportCsvBtn.disabled = currentVideos.length === 0;
      } catch (err) {
        console.error(err);
        setStatus("ì˜¤ë¥˜: " + err.message, "error");
        resultsInfoEl.textContent = "ì—ëŸ¬ ë°œìƒ";
        resultsListEl.innerHTML =
          '<div class="empty-state">ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤, ì¿¼í„°, ì…ë ¥ê°’(ì±„ë„/í‚¤ì›Œë“œ/URL)ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
      } finally {
        fetchBtn.disabled = false;
      }
    }

    // ------ ì±„ë„ í›„ë³´ ë Œë”ë§ ------
    function renderChannelCandidates(channels) {
      currentVideos = [];
      resetStats();
      resultsListEl.innerHTML = "";
      if (!channels || !channels.length) {
        resultsListEl.innerHTML =
          '<div class="empty-state">í‘œì‹œí•  ì±„ë„ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const fr = document.createDocumentFragment();
      channels.forEach((ch) => {
        const card = document.createElement("article");
        card.className = "channel-card";

        const thumbDiv = document.createElement("div");
        thumbDiv.className = "channel-thumb";
        if (ch.thumbnail && ch.thumbnail.url) {
          const img = document.createElement("img");
          img.src = ch.thumbnail.url;
          img.alt = ch.title;
          thumbDiv.appendChild(img);
        } else {
          thumbDiv.innerHTML =
            '<div style="width:64px;height:64px;border-radius:50%;border:1px solid #4b5563;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:#6b7280;">No</div>';
        }

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "channel-body";
        const titleDiv = document.createElement("div");
        titleDiv.className = "channel-title";
        titleDiv.textContent = ch.title;

        const idDiv = document.createElement("div");
        idDiv.className = "channel-id";
        idDiv.textContent = "ID: " + ch.id;

        const hintDiv = document.createElement("div");
        hintDiv.className = "channel-hint";
        hintDiv.textContent = "ì´ ì±„ë„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì±„ë„ ì˜ìƒë“¤ì„ ë¶„ì„í•©ë‹ˆë‹¤.";

        bodyDiv.appendChild(titleDiv);
        bodyDiv.appendChild(idDiv);
        bodyDiv.appendChild(hintDiv);

        card.appendChild(thumbDiv);
        card.appendChild(bodyDiv);

        card.addEventListener("click", () => {
          channelIdInput.value = ch.id; // IDë¡œ ì„¸íŒ… í›„ ë‹¤ì‹œ ë¶„ì„
          fetchVideos();
        });

        fr.appendChild(card);
      });

      resultsListEl.appendChild(fr);
    }

    // ------ ê²°ê³¼ ë Œë”ë§ (ì„¤ëª… ì—†ëŠ” ë²„ì „ + ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€) ------
    function renderVideos() {
      if (!currentVideos.length) {
        resultsListEl.innerHTML =
          '<div class="empty-state">í‘œì‹œí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const fr = document.createDocumentFragment();

      currentVideos.forEach((video) => {
        const snippet = video.snippet || {};
        const stats = video.statistics || {};
        const content = video.contentDetails || {};
        const vid = video.id;
        const title = snippet.title || "";
        const publishedAt = snippet.publishedAt || "";
        const thumbObj =
          (snippet.thumbnails &&
            (snippet.thumbnails.medium || snippet.thumbnails.default)) ||
          null;
        const thumbUrl = thumbObj && thumbObj.url ? thumbObj.url : null;
        const durationSeconds = isoDurationToSeconds(content.duration);
        const views = Number(stats.viewCount || 0);
        const likes = Number(stats.likeCount || 0);
        const comments = Number(stats.commentCount || 0);

        const hoursSince = (() => {
          const t = new Date(publishedAt).getTime();
          if (isNaN(t)) return null;
          const diffMs = Date.now() - t;
          if (diffMs <= 0) return null;
          return diffMs / (1000 * 60 * 60);
        })();

        const vph =
          hoursSince && hoursSince > 0
            ? (views / hoursSince).toFixed(1)
            : null;

        const card = document.createElement("article");
        card.className = "video-card";

        const thumbDiv = document.createElement("div");
        thumbDiv.className = "video-thumb";
        if (thumbUrl) {
          const img = document.createElement("img");
          img.src = thumbUrl;
          img.alt = title;
          thumbDiv.appendChild(img);
        } else {
          thumbDiv.innerHTML =
            '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:#6b7280;">No Thumbnail</div>';
        }
        const durBadge = document.createElement("div");
        durBadge.className = "video-duration";
        durBadge.textContent = formatSecondsToHMS(durationSeconds);
        thumbDiv.appendChild(durBadge);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "video-body";

        const titleDiv = document.createElement("div");
        titleDiv.className = "video-title";
        titleDiv.textContent = title;

        const metaDiv = document.createElement("div");
        metaDiv.className = "video-meta";
        metaDiv.innerHTML = `
          <span>ğŸ“… ${formatDate(publishedAt)} (${timeSinceUpload(publishedAt)})</span>
          <span>ğŸ‘ï¸ ${formatNumber(views)}íšŒ</span>
          <span>ğŸ‘ ${formatNumber(likes)}</span>
          <span>ğŸ’¬ ${formatNumber(comments)}</span>
          <span>â±ï¸ ${vph !== null ? vph + " VPH" : "-"}</span>
        `;

        const linkDiv = document.createElement("div");
        linkDiv.className = "video-link";

        let html =
          '<a class="primary" href="https://www.youtube.com/watch?v=' +
          encodeURIComponent(vid) +
          '" target="_blank" rel="noopener noreferrer">â–¶ YouTubeì—ì„œ ì—´ê¸°</a>';

        if (thumbUrl) {
          // ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
          html +=
            '<a href="' +
            thumbUrl +
            '" download target="_blank" rel="noopener noreferrer">â¬‡ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ</a>';
        }

        linkDiv.innerHTML = html;

        bodyDiv.appendChild(titleDiv);
        bodyDiv.appendChild(metaDiv);
        bodyDiv.appendChild(linkDiv);

        card.appendChild(thumbDiv);
        card.appendChild(bodyDiv);

        fr.appendChild(card);
      });

      resultsListEl.innerHTML = "";
      resultsListEl.appendChild(fr);
    }

    // ------ í†µê³„ ê³„ì‚° ------
    function resetStats() {
      statTotalViewsEl.textContent = "-";
      statAvgViewsEl.textContent = "-";
      statAvgVphEl.textContent = "-";
      statAvgDurationEl.textContent = "-";
      statAvgTitleLenEl.textContent = "-";
      statLatestEl.textContent = "-";
      keywordListEl.innerHTML =
        '<span class="empty-state">ì œëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì—ì„œ ë§ì´ ì“°ì¸ ë‹¨ì–´ë“¤ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</span>';
    }

    function computeStats() {
      if (!currentVideos.length) {
        resetStats();
        return;
      }

      let totalViews = 0;
      let totalDurationSec = 0;
      let totalTitleLen = 0;
      let totalVph = 0;
      let vphCount = 0;
      let latestDate = null;

      const keywordFreq = new Map();

      currentVideos.forEach((video) => {
        const snippet = video.snippet || {};
        const stats = video.statistics || {};
        const content = video.contentDetails || {};

        const views = Number(stats.viewCount || 0);
        const publishedAt = snippet.publishedAt || "";
        const durationSeconds = isoDurationToSeconds(content.duration);
        const title = snippet.title || "";

        totalViews += views;
        totalDurationSec += durationSeconds;
        totalTitleLen += title.length;

        const t = new Date(publishedAt).getTime();
        if (!isNaN(t)) {
          if (!latestDate || t > latestDate.getTime()) {
            latestDate = new Date(t);
          }
          const diffHours = (Date.now() - t) / (1000 * 60 * 60);
          if (diffHours > 0) {
            totalVph += views / diffHours;
            vphCount++;
          }
        }

        const tokens = tokenizeTitle(title);
        tokens.forEach((token) => {
          const old = keywordFreq.get(token) || 0;
          keywordFreq.set(token, old + 1);
        });
      });

      const count = currentVideos.length;
      const avgViews = totalViews / count;
      const avgDurationSec = totalDurationSec / count;
      const avgTitleLen = totalTitleLen / count;
      const avgVph = vphCount > 0 ? totalVph / vphCount : null;

      statTotalViewsEl.textContent = formatNumber(totalViews);
      statAvgViewsEl.textContent = isFinite(avgViews) ? formatNumber(Math.round(avgViews)) : "-";
      statAvgDurationEl.textContent = isFinite(avgDurationSec)
        ? (avgDurationSec / 60).toFixed(1) + "ë¶„"
        : "-";
      statAvgTitleLenEl.textContent = isFinite(avgTitleLen)
        ? avgTitleLen.toFixed(1) + "ì"
        : "-";
      statAvgVphEl.textContent =
        avgVph !== null && isFinite(avgVph) ? avgVph.toFixed(1) + " VPH" : "-";
      statLatestEl.textContent = latestDate ? formatDate(latestDate.toISOString()) : "-";

      renderKeywordTop(keywordFreq);
    }

    function renderKeywordTop(freqMap) {
      keywordListEl.innerHTML = "";
      if (!freqMap || !freqMap.size) {
        keywordListEl.innerHTML =
          '<span class="empty-state">ì œëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì—ì„œ ë§ì´ ì“°ì¸ ë‹¨ì–´ë“¤ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</span>';
        return;
      }

      const arr = Array.from(freqMap.entries());
      const stopwords = new Set([
        "ì˜ìƒ", "ì •ë§", "ì˜¤ëŠ˜", "ì´í˜¼", "ì „ì²˜", "ì´ì•¼ê¸°", "ì‚¬ì—°", "ì‚¬ëŒ", "ìš°ë¦¬",
        "ê·¸ë…€", "ê·¸ëŠ”", "ë‹¹í•œ", "í›„", "ê¹Œì§€", "ê·¸ë¦¬ê³ "
      ]);

      const filtered = arr
        .filter(([token, count]) => {
          if (count < 2) return false;
          if (stopwords.has(token)) return false;
          return true;
        })
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15);

      if (!filtered.length) {
        keywordListEl.innerHTML =
          '<span class="empty-state">ìì£¼ ë°˜ë³µë˜ëŠ” í‚¤ì›Œë“œê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.</span>';
        return;
      }

      filtered.forEach(([token, count]) => {
        const chip = document.createElement("span");
        chip.className = "keyword-chip";
        chip.innerHTML =
          token + '<span class="count">Ã—' + count + "</span>";
        keywordListEl.appendChild(chip);
      });
    }

    // ------ CSV ë‚´ë³´ë‚´ê¸° ------
    function exportCsv() {
      if (!currentVideos.length) return;
      const rows = [];
      rows.push([
        "videoId",
        "title",
        "publishedAt",
        "durationSeconds",
        "views",
        "likes",
        "comments",
        "VPH",
        "url"
      ]);

      currentVideos.forEach((video) => {
        const snippet = video.snippet || {};
        const stats = video.statistics || {};
        const content = video.contentDetails || {};
        const vid = video.id;
        const title = (snippet.title || "").replace(/"/g, '""');
        const publishedAt = snippet.publishedAt || "";
        const durationSeconds = isoDurationToSeconds(content.duration);
        const views = Number(stats.viewCount || 0);
        const likes = Number(stats.likeCount || 0);
        const comments = Number(stats.commentCount || 0);

        const t = new Date(publishedAt).getTime();
        let vph = "";
        if (!isNaN(t)) {
          const diffHours = (Date.now() - t) / (1000 * 60 * 60);
          if (diffHours > 0) {
            vph = (views / diffHours).toFixed(2);
          }
        }

        rows.push([
          vid,
          '"' + title + '"',
          publishedAt,
          durationSeconds,
          views,
          likes,
          comments,
          vph,
          "https://www.youtube.com/watch?v=" + vid
        ]);
      });

      const csv = rows
        .map((row) => row.join(","))
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const now = new Date();
      const ts =
        now.getFullYear().toString() +
        String(now.getMonth() + 1).padStart(2, "0") +
        String(now.getDate()).padStart(2, "0") +
        "_" +
        String(now.getHours()).padStart(2, "0") +
        String(now.getMinutes()).padStart(2, "0");
      a.download = "youtube_analysis_" + ts + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ------ ì´ë²¤íŠ¸ ë°”ì¸ë”© ------
    fetchBtn.addEventListener("click", fetchVideos);
    exportCsvBtn.addEventListener("click", exportCsv);

    [channelIdInput, keywordInput, maxResultsInput, daysRangeInput].forEach((el) => {
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          fetchVideos();
        }
      });
    });
  </script>
</body>
</html>
